<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <title>Dashboard</title>
</head>

<body>

    <div class="container">

    </div>

    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
        <div class="container-fluid">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" href="/dashboard">Admin Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard/listUsers">Users</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/product">Products</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/categories">Catagories</a>
                </li>
            </ul>

            <ul>
                <li class="nav-item bg-light p-2 rounded-pill">
                    <a class="nav-link" href="/dashboard/logout">Log-Out</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="input-group d-flex my-3 mx-5">
        <div class="form-outline">
            <input type="search" placeholder="Search" id="searchInput" class="form-control" oninput="search()"
                autofocus="true" />
        </div>
    </div>
    <div class="container mt-4">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>User-ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Created At</th>
                        <th>Edit</th>

                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody class="userData">

                </tbody>
            </table>
        </div>
    </div>

</body>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.10.1/dist/sweetalert2.all.min.js"></script>
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/sweetalert2@10.10.1/dist/sweetalert2.min.css'>

</html>
<script>
    const search = async (value) => {

        console.log("ðŸš€ ~ file: listUsers.ejs:80 ~ search ~ val:", val)

        if (!val) {
            fetchUserData()
        }
        let searches = await fetch(`/dashboard/user/search/data?val=${val}`)
        let Searchdata = await searches.json();
        let SearchResults = Searchdata.data

    }

    async function fetchUserData() {
        const rec = await fetch('/dashboard/UserRecords');
        const userRecord = await rec.json();

        if (userRecord.status == 200 && userRecord.data) {
            let allUserRecord = []
            allUserRecord = userRecord.data

            let html = '';

            allUserRecord.forEach((user, i) => {
                let htmlSegment = `<tr>
                        <td>${i + 1}</td>
                        <td>${user.userId}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.created_at}</td>
                        <td><a id="${user.id}"class="nav-link bg-info text-center text-white rounded-pill" onClick ="EditAction(this)"><i class="bi bi-pen-fill text-dark"></i></a></td>
                        <td><a id="${user.userId}" class="nav-link bg-danger text-center text-white rounded-pill" onClick ="DeleteAction(this)">Delete</a></td>
                    </tr>`;
                i++;
                html += htmlSegment;
            });
            let container = document.querySelector('.userData');
            container.innerHTML = html;

        }
    }
    fetchUserData()
    async function DeleteAction(e) {
        e.preventDefault();
        console.log(e.id);
        const submitForm = await fetch('/dashboard/deleteRecord', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id: e.id
            })
        })
        const results = await submitForm.json();
        if (results.status === 200) {
            const Toast2 = Swal.mixin({
                toast: true,
                position: 'top',
                showConfirmButton: false,
                timer: 7000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            })

            Toast2.fire({
                icon: 'success',
                title: `${results.message}`
            })
            fetchUserData()
        }
    }

    async function EditAction(target) {
        window.location.assign(`/dashboard/user/?id=${target.id}`)
    }
</script>